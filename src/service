#!/bin/bash

source ${PWD}/config/helper
source .env

load_config(){
    cfg.parser './config/services.ini' && 
        if [ "$(type -t cfg.section.${1})" = 'function' ]; then
            cfg.section.${1}
        else
            echo service not found ${1}
            exit 1
        fi
}

install_service() {
    cfg.parser './config/services.ini' && cfg.section.${1} &&
    cd $repos_dir &&
    if ! [ -d $repo_name ] ; then
        git clone $repo
    fi
    cd $repo_name
    echo deploy_mode=${deploy_mode} > .env
    IFS=', ' read -r -a array <<< "$networks"
    for var in ${array[*]}
    do
        net="${1}_net_ip"
        if ! grep -q $net .env ; then
            echo ${net}=${!net} >> .env
        fi
    done
    ./please install $work_dir develop
}

up_service(){
    cfg.parser './config/services.ini' && cfg.section.${1} &&
    cd $repos_dir/$repo_name &&
    ./please up $1
}

link_service(){
    cfg.parser './config/services.ini' && cfg.section.${2} &&
    croute=$route && cfg.section.${1} &&
    cfg.parser './config/network.ini' && cfg.section.${1} &&
    cd $repos_dir/$repo_name &&
    link="${2}_ip"
    ./please link $croute ${!link}
}



test_service(){
    cfg.parser './config/services.ini'
    echo $(cfg.section.${1})
    cfg_network=$(cfg.parser './config/network.ini')
    cfg_network.section.${1}
    echo $self_ip
    echo $repo_name
}

print_help_install() {
    echo "only provide services: "
    echo "domain"
}

service_handler() {
    case $1 in
        install) 
            install_service $2;;
        up)
            up_service $2;;
        test)
            test_service $2;;
        link)
            link_service $2 $3;;
        *) 
            print_help_install
    esac
}
